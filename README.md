# Telegram Shop Backend

**Современный backend для мульти-магазинного Telegram магазина с поддержкой WebApp, интеграцией с платежными системами (Stripe, PayPal, YooKassa) и продвинутой архитектурой на FastAPI.**

---

## Возможности

- Аутентификация через Telegram WebApp
- Мульти-магазинность, роли (owner/admin/manager/customer)
- CRUD для товаров, категорий, заказов, корзины, отзывов
- Интеграция с платежами: Stripe, PayPal, YooKassa
- Вебхуки для оплаты и Telegram
- Поддержка возвратов (refund)
- Асинхронный Telegram-бот
- Docker-ready, Alembic миграции
- Продвинутый CI/CD (GitHub Actions)
- Эндпоинт healthcheck для мониторинга

---

## Структура проекта
textbackend/
  app/
    api/         # FastAPI ручки (v1)
    core/        # Настройки, безопасность
    crud/        # CRUD-операции с БД
    db/          # SQLAlchemy база, миграции
    models/      # ORM модели
    schemas/     # Pydantic схемы
    services/    # Бизнес-логика (Telegram, платежи)
  alembic/       # Миграции
  main.py        # Точка входа FastAPI
  pyproject.toml # Зависимости Poetry
  ...

## Основные API эндпоинты

/api/v1/auth/telegram-login — Логин через Telegram
/api/v1/shops/ — Магазины
/api/v1/products/ — Товары
/api/v1/categories/ — Категории
/api/v1/cart/ — Корзина
/api/v1/orders/ — Заказы
/api/v1/payments/ — Платежи, вебхуки, возвраты
/api/v1/telegram/webhook — Webhook Telegram
/api/v1/health — Healthcheck

Swagger: /api/v1/docs

## CI/CD

Линтинг (black, isort, flake8, mypy)
Запуск тестов (pytest)
Сборка и публикация Docker-образа
Деплой на сервер (по main)

Файл: .github/workflows/ci-cd.yml

## Тесты

Запуск всех тестов:
bashpoetry run pytest tests/



**Безопасность в проекте**

Проект реализует несколько уровней защищённости для предотвращения несанкционированного доступа и обеспечения безопасности данных и транзакций.

**1. Аутентификация и авторизация**

- **JWT-токены:**
  Для всех приватных API используется OAuth2 с JWT-токеном (HS256).
  Токен генерируется после успешного входа через Telegram и проверяется на каждом защищённом эндпоинте.

- **OAuth2PasswordBearer:**
  Все защищённые ручки используют dependency-инъекции для обязательной проверки токена.

- **Проверка ролей:**
  Внутри эндпоинтов используется декоратор и функции проверки ролей (`owner`, `admin`, `manager`) для ограничения доступа к магазину и его операциям.

- **Валидация Telegram WebApp логина:**
  Подпись Telegram проверяется через HMAC-SHA256 (метод `verify_telegram_auth`), предотвращая подделку авторизации.

**2. Безопасность платежей**

- **Проверка webhook-секретов:**
  Вебхуки платежных систем (Stripe, PayPal, YooKassa) и Telegram защищены секретом/подписью.
  Payload и заголовки проверяются на валидность (например, Stripe webhook secret, PayPal Signature, etc).

- **Изоляция ключей:**
  Все ключи (секреты JWT, Telegram, Stripe/PayPal/YooKassa) задаются только через `.env` и/или переменные окружения.
  В базе данных и в репозитории ключи не хранятся!

**3. CORS и защита API**

- **CORS (Cross-Origin Resource Sharing):**
  Для разработки разрешены все домены (`["*"]`), но для production требуется ограничить допустимые источники во избежание XSS и CSRF.

- **Ограничение методов и заголовков:**
  Через настройки FastAPI/CORS можно детально настроить допустимые HTTP-методы.

**4. Интеграция с внешними сервисами**

- **Асинхронные вызовы через httpx:**
  Все внешние запросы отправляются через httpx, исключая блокировку потоков и возможные DoS на API.

- **Проверка IP (можно доработать):**
  Для YooKassa реализуется возможность проверки IP отправителя webhook (рекомендуется для production).

**5. Безопасность хранения и доступа**

- **Данные пользователей:**
  Email, телефон, username, Telegram ID — хранятся только в базе данных и не отдаются наружу без авторизации.

- **Загрузка файлов:**
  Для изображений товаров/категорий реализована базовая обработка. В production рекомендуется ограничить размер, MIME-типы и использовать внешнее хранилище (S3/Minio), чтобы избежать XSS и загрузки вредоносных файлов.

- **Нет хранения паролей:**
  Пароли пользователей не хранятся, вход только через Telegram (OAuth2).

**6. DevOps/CI/CD и аудит**

- **CI/CD включает линтинг и тесты:**
  Каждый коммит проверяется на типовые ошибки (black, isort, flake8, mypy, pytest).
- **Security scan:**
  Используется Bandit/Safety для проверки зависимостей на известные уязвимости.
- **Healthcheck endpoint:**
  Для мониторинга жизнеспособности сервиса.

**7. Прочее**

- **Нет секретов в репозитории:**
  `.env` и другие секретные файлы добавлены в `.gitignore`.
- **Ограничение прав на уровне бизнес-логики:**
  Все критичные операции (например, возвраты платежей, управление магазином) доступны только авторизованным пользователям с соответствующими ролями.


## Скрипты

scripts/init_db.py — Инициализация БД
scripts/backup.py — Бэкапы БД
scripts/setup_bot.py — Настройка Telegram webhook
scripts/generate_test_data.py — Генерация тестовых данных



Авторы

LavierCasey
